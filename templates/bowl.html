<!DOCTYPE html>
<html>
<head>
    <title>Lucky Bowl</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #1a0033; color: white; display: flex; flex-direction: column; align-items: center; overflow: hidden; height: 100vh; margin:0; }
        canvas { border-radius: 50%; border: 10px solid gold; margin-top: 20px; background: #000; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px; max-height: 150px; overflow-y: auto; }
        .num { border: 1px solid gold; padding: 5px; text-align: center; cursor: pointer; }
        .selected { background: gold; color: black; font-weight: bold; }
        button { background: gold; color: black; border: none; padding: 15px 30px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <h2 id="msg">ðŸŽ± SELECT 1-5 NUMBERS</h2>
    <canvas id="bowl" width="250" height="250"></canvas>
    
    <div class="grid" id="grid"></div>
    <button onclick="play()" id="playBtn">PLAY (100 XP)</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
        
        let picks = [];
        const grid = document.getElementById('grid');
        
        // Generate 1-99
        for(let i=1; i<=99; i++) {
            let d = document.createElement('div');
            d.className = 'num'; d.innerText = i;
            d.onclick = () => toggle(i, d);
            grid.appendChild(d);
        }

        function toggle(n, el) {
            if(picks.includes(n)) {
                picks = picks.filter(x => x !== n);
                el.classList.remove('selected');
            } else {
                if(picks.length >= 5) { tg.showAlert("Max 5 Numbers!"); return; }
                picks.push(n);
                el.classList.add('selected');
            }
        }

        function play() {
            if(picks.length === 0) { tg.showAlert("Select at least 1 number!"); return; }
            
            tg.showConfirm(`Cost: 100 XP. Play?`, ok => {
                if(ok) {
                    fetch('/api/deduct_fee', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ user_id: userId, amount: 100, game_name: 'Bowl' })
                    }).then(r=>r.json()).then(d => {
                        if(d.status === 'success') {
                            startBowl();
                        } else tg.showAlert(d.msg);
                    });
                }
            });
        }

        // Canvas Animation
        const ctx = document.getElementById('bowl').getContext('2d');
        let balls = [];
        for(let i=0; i<10; i++) balls.push({x:125, y:125, vx: Math.random()*10-5, vy: Math.random()*10-5, color:`hsl(${Math.random()*360},100%,50%)`});

        function animate() {
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.fillRect(0,0,250,250);
            balls.forEach(b => {
                b.x+=b.vx; b.y+=b.vy;
                if(b.x<0||b.x>250) b.vx*=-1; if(b.y<0||b.y>250) b.vy*=-1;
                ctx.beginPath(); ctx.arc(b.x, b.y, 8, 0, Math.PI*2); ctx.fillStyle=b.color; ctx.fill();
            });
            requestAnimationFrame(animate);
        }
        animate();

        function startBowl() {
            document.getElementById('playBtn').style.display = 'none';
            document.getElementById('msg').innerText = "ROLLING... (Wait 10s)";
            
            // 10 Second Hype
            setTimeout(() => {
                // Determine Winner
                // 95% Loss, 5% Win (Jackpot is hard)
                let winNum = 0;
                let won = false;
                
                if(Math.random() < 0.05) {
                    winNum = picks[Math.floor(Math.random()*picks.length)];
                    won = true;
                } else {
                    // Near miss logic
                    let target = picks[0];
                    winNum = target + (Math.random() < 0.5 ? 1 : -1); 
                    if(winNum < 1) winNum = 2;
                }
                
                document.getElementById('msg').innerText = `WINNING NUMBER: ${winNum}`;
                
                setTimeout(() => {
                    if(won) {
                        fetch('/api/claim_win', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ user_id: userId, amount: 9000, game_name: 'Bowl' })
                        });
                        tg.showAlert("ðŸŽ± JACKPOT!!! 9000 XP WON!");
                    } else {
                        tg.showAlert(`ðŸ’” Miss ho gaya! Winning Ball: ${winNum}`);
                    }
                    tg.close();
                }, 2000);

            }, 10000);
        }
    </script>
</body>
</html>