<!DOCTYPE html>
<html>
<head>
    <title>Neon Snake</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #000; color: #0f0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; font-family: monospace; overflow: hidden; touch-action: none; }
        canvas { border: 2px solid #0f0; box-shadow: 0 0 20px #0f0; background: #111; display: none; }
        #startScreen { text-align: center; }
        button { background: #0f0; color: #000; border: none; padding: 15px 30px; font-size: 20px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="startScreen">
        <h1>üêç NEON SNAKE</h1>
        <p>Fee: 20 XP | Win: 2 XP/Apple</p>
        <button onclick="payAndStart()">PLAY (20 XP)</button>
    </div>
    
    <div id="scoreBox" style="display:none; color:yellow; font-size:20px; margin-bottom:10px;">Score: 0</div>
    <canvas id="game" width="300" height="300"></canvas>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const box = 15;
        let score = 0;
        let snake = []; 
        let food = {};
        let d;
        let game;

        function payAndStart() {
            tg.MainButton.showProgress();
            fetch('/api/deduct_fee', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: userId, amount: 20, game_name: 'Snake' })
            })
            .then(res => res.json())
            .then(data => {
                tg.MainButton.hideProgress();
                if(data.status === 'success') {
                    document.getElementById('startScreen').style.display = 'none';
                    canvas.style.display = 'block';
                    document.getElementById('scoreBox').style.display = 'block';
                    startGame();
                } else {
                    tg.showAlert("‚ùå " + data.msg);
                }
            });
        }

        function startGame() {
            snake = [{x: 9 * box, y: 10 * box}];
            score = 0;
            d = null;
            document.getElementById('scoreBox').innerText = "Score: " + score;
            food = { x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box };
            if(game) clearInterval(game);
            game = setInterval(draw, 100);
        }

        // TOUCH CONTROLS (Swipe)
        let tsX = 0, tsY = 0;
        document.addEventListener('touchstart', e => { tsX = e.touches[0].clientX; tsY = e.touches[0].clientY; }, {passive: false});
        document.addEventListener('touchmove', e => { e.preventDefault(); }, {passive: false}); // Prevent Scroll
        document.addEventListener('touchend', e => {
            let teX = e.changedTouches[0].clientX;
            let teY = e.changedTouches[0].clientY;
            let diffX = tsX - teX;
            let diffY = tsY - teY;

            if(Math.abs(diffX) > Math.abs(diffY)) {
                if(diffX > 0 && d != "RIGHT") d = "LEFT";
                else if(diffX < 0 && d != "LEFT") d = "RIGHT";
            } else {
                if(diffY > 0 && d != "DOWN") d = "UP";
                else if(diffY < 0 && d != "UP") d = "DOWN";
            }
        });

        function draw() {
            ctx.fillStyle = "#111"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            for(let i=0; i<snake.length; i++) {
                ctx.fillStyle = (i==0)? "#0f0" : "#050";
                ctx.fillRect(snake[i].x, snake[i].y, box, box);
            }
            ctx.fillStyle = "red"; ctx.fillRect(food.x, food.y, box, box);

            let snakeX = snake[0].x; let snakeY = snake[0].y;
            if(d == "LEFT") snakeX -= box;
            if(d == "UP") snakeY -= box;
            if(d == "RIGHT") snakeX += box;
            if(d == "DOWN") snakeY += box;

            if(snakeX == food.x && snakeY == food.y) {
                score++;
                document.getElementById('scoreBox').innerText = "Score: " + score;
                food = { x: Math.floor(Math.random()*19+1)*box, y: Math.floor(Math.random()*19+1)*box };
            } else { snake.pop(); }

            let newHead = { x: snakeX, y: snakeY };
            if(snakeX < 0 || snakeX >= canvas.width || snakeY < 0 || snakeY >= canvas.height || collision(newHead, snake)) {
                clearInterval(game);
                gameOver();
            }
            snake.unshift(newHead);
        }
        function collision(head, array) {
            for(let i=0; i<array.length; i++) { if(head.x == array[i].x && head.y == array[i].y) return true; }
            return false;
        }
        function gameOver() {
            let win = score * 2;
            if(win > 0) {
                fetch('/api/claim_win', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: userId, amount: win, game_name: 'Snake' })
                });
                tg.showAlert(`üêç Game Over!\nüçé Score: ${score}\nüí∞ Won: ${win} XP`);
            } else {
                tg.showAlert("üêç Game Over! Kuch nahi mila.");
            }
            tg.close();
        }
    </script>
</body>
</html>